<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÆ∂Ë®àÁ∞ø</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            padding-top: 80px;
            padding-bottom: 20px;
            color: #e0e0e0;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 12, 41, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header-nav {
            display: flex;
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
            overflow-x: auto;
        }

        .header-nav::-webkit-scrollbar {
            height: 0;
        }

        .nav-btn {
            flex-shrink: 0;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        /* „Éà„Éº„Çπ„Éà„É°„ÉÉ„Çª„Éº„Ç∏ */
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(56, 239, 125, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 700;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
        }

        /* Ë®àÁÆóÊ©ü„É¢„Éº„ÉÄ„É´ */
        .calculator-modal {
            display: none;
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 12, 41, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            z-index: 1500;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 350px;
            width: 90%;
        }

        .calculator-modal.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .calc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calc-close {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calc-display {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: right;
            font-size: 32px;
            font-weight: 900;
            color: #ffffff;
            margin-bottom: 15px;
            min-height: 60px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calc-display:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .calc-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calc-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .calc-btn.operator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .calc-btn.equals {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            grid-column: span 2;
        }

        .calc-btn.clear {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        /* CSVÂá∫Âäõ„É¢„Éº„ÉÄ„É´ */
        .csv-modal {
            display: none;
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 12, 41, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            z-index: 1500;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .csv-modal.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-close {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px 20px 20px;
        }

        .content-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            padding: 35px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Á∞°Áï•Ë°®Á§∫„Çπ„Çø„Ç§„É´ */
        .simple-mode .category-item {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.03);
        }

        .simple-mode .category-summary {
            padding: 8px;
            margin-bottom: 8px;
        }

        .simple-mode .category-summary-name {
            font-size: 14px;
        }

        .simple-mode .category-summary-amount {
            font-size: 14px;
        }

        .simple-mode .category-details {
            margin-top: 8px;
        }

        .simple-mode .subcategory-item {
            padding: 8px;
            margin-bottom: 6px;
        }

        .simple-mode .subcategory-name {
            font-size: 13px;
        }

        .simple-mode .add-subcategory {
            padding: 8px;
            margin-top: 8px;
        }

        .simple-mode input[type="text"],
        .simple-mode input[type="number"] {
            padding: 8px;
            font-size: 14px;
        }

        .simple-mode button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .sync-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            animation: fadeIn 0.3s ease-out;
        }

        .sync-status.synced {
            background: rgba(56, 239, 125, 0.2);
            color: #38ef7d;
            border: 1px solid rgba(56, 239, 125, 0.3);
        }

        .sync-status.syncing {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .sync-status.error {
            background: rgba(245, 87, 108, 0.2);
            color: #f5576c;
            border: 1px solid rgba(245, 87, 108, 0.3);
        }

        h2 {
            font-weight: 700;
            letter-spacing: 1px;
            color: #ffffff;
        }

        .month-selector {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .month-selector:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .month-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        .month-selector button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .month-selector button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .month-selector button:active {
            transform: translateY(0);
        }

        .month-display {
            font-size: 24px;
            font-weight: 900;
            color: #ffffff;
            min-width: 140px;
            text-align: center;
            letter-spacing: 1px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .add-category {
            margin-bottom: 25px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 10px;
        }

        input[type="text"], input[type="number"], input[type="month"], select {
            flex: 1;
            padding: 14px;
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            transition: all 0.3s ease;
            font-family: 'Noto Sans JP', sans-serif;
        }

        input[type="text"]::placeholder, input[type="number"]::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus, input[type="month"]:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        select option {
            background: #1a1a2e;
            color: #ffffff;
        }

        button {
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            font-family: 'Noto Sans JP', sans-serif;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        button:active {
            transform: scale(0.98);
        }

        button.delete-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 8px 14px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        button.delete-btn:hover {
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        button.edit-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 8px 14px;
            font-size: 14px;
            margin-right: 5px;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        button.edit-btn:hover {
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);
        }

        .category-list {
            margin-top: 30px;
        }

        .category-item {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .category-item:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .category-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .category-summary:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .category-summary-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .accordion-icon {
            font-size: 20px;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: #ffffff;
        }

        .accordion-icon.open {
            transform: rotate(90deg);
            color: #e0e0e0;
        }

        .category-summary-name {
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 0.5px;
        }

        .category-summary-amount {
            font-size: 18px;
            font-weight: 900;
            color: #ffffff;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .category-details {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .category-details.open {
            max-height: 2000px;
            opacity: 1;
            margin-top: 15px;
        }

        .category-header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
            animation: fadeIn 0.5s ease-out;
        }

        .category-name {
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 0.5px;
        }

        .category-amount {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .category-amount input {
            width: 130px;
        }

        .category-actions {
            display: flex;
            gap: 8px;
        }

        .subcategory-list {
            margin-top: 15px;
            padding-left: 20px;
        }

        .subcategory-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 12px;
            padding: 15px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .subcategory-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .sub-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .subcategory-name {
            font-size: 16px;
            color: #e0e0e0;
            font-weight: 500;
        }

        .note-text {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
            margin-top: 5px;
        }

        .note-input {
            width: 100%;
            margin-top: 8px;
            font-size: 14px;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            color: #ffffff;
            transition: all 0.3s ease;
        }

        .note-input:focus {
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
            outline: none;
        }

        .add-subcategory {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .add-subcategory:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .total-section {
            margin-top: 35px;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            animation: fadeIn 0.6s ease-out;
        }

        .total-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 50px rgba(102, 126, 234, 0.6);
        }

        .total-section h2 {
            margin-bottom: 15px;
            font-weight: 900;
            letter-spacing: 2px;
        }

        .total-amount {
            font-size: 42px;
            font-weight: 900;
            letter-spacing: 2px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .half-amount {
            font-size: 22px;
            margin-top: 12px;
            opacity: 0.95;
            font-weight: 700;
        }

        .output-section {
            margin-top: 30px;
            animation: fadeIn 0.7s ease-out;
        }

        .output-text {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            min-height: 200px;
            margin-bottom: 20px;
            color: #e0e0e0;
            transition: all 0.3s ease;
        }

        .output-text:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .copy-btn {
            width: 100%;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            box-shadow: 0 4px 15px rgba(56, 239, 125, 0.4);
            font-weight: 900;
            letter-spacing: 1px;
        }

        .copy-btn:hover {
            box-shadow: 0 6px 20px rgba(56, 239, 125, 0.6);
        }

        .copy-success {
            text-align: center;
            color: #38ef7d;
            margin-top: 12px;
            font-weight: 700;
            animation: fadeIn 0.3s ease-out;
        }

        .discord-btn {
            width: 100%;
            background: #5865F2;
            color: white;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 900;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(88, 101, 242, 0.4);
        }

        .discord-btn:hover {
            background: #4752C4;
            box-shadow: 0 6px 20px rgba(88, 101, 242, 0.6);
        }

        .discord-icon {
            width: 24px;
            height: 24px;
        }

        @media (max-width: 600px) {
            .total-amount {
                font-size: 32px;
            }
        }
    </style>
</head>
<body>
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="header">
        <div class="header-nav">
            <button class="nav-btn active" onclick="showSection('budget')">üìä ÂÆ∂Ë®àÁ∞ø</button>
            <button class="nav-btn" onclick="showCalculator()">üî¢ Ë®àÁÆóÊ©ü</button>
            <button class="nav-btn" onclick="showCSVModal()">üì• CSVÂá∫Âäõ</button>
        </div>
    </div>

    <!-- „Éà„Éº„Çπ„Éà„É°„ÉÉ„Çª„Éº„Ç∏ -->
    <div class="toast" id="toast"></div>

    <!-- Ë®àÁÆóÊ©ü„É¢„Éº„ÉÄ„É´ -->
    <div class="calculator-modal" id="calculatorModal">
        <div class="calc-header">
            <h2>üî¢ Ë®àÁÆóÊ©ü</h2>
            <button class="calc-close" onclick="closeCalculator()">‚úï</button>
        </div>
        <div class="calc-display" id="calcDisplay" onclick="copyCalcResult()">0</div>
        <div class="calc-buttons">
            <button class="calc-btn clear" onclick="clearCalc()">C</button>
            <button class="calc-btn" onclick="appendCalc('(')">(</button>
            <button class="calc-btn" onclick="appendCalc(')')">)</button>
            <button class="calc-btn operator" onclick="appendCalc('√∑')">√∑</button>
            
            <button class="calc-btn" onclick="appendCalc('7')">7</button>
            <button class="calc-btn" onclick="appendCalc('8')">8</button>
            <button class="calc-btn" onclick="appendCalc('9')">9</button>
            <button class="calc-btn operator" onclick="appendCalc('√ó')">√ó</button>
            
            <button class="calc-btn" onclick="appendCalc('4')">4</button>
            <button class="calc-btn" onclick="appendCalc('5')">5</button>
            <button class="calc-btn" onclick="appendCalc('6')">6</button>
            <button class="calc-btn operator" onclick="appendCalc('-')">-</button>
            
            <button class="calc-btn" onclick="appendCalc('1')">1</button>
            <button class="calc-btn" onclick="appendCalc('2')">2</button>
            <button class="calc-btn" onclick="appendCalc('3')">3</button>
            <button class="calc-btn operator" onclick="appendCalc('+')">+</button>
            
            <button class="calc-btn" onclick="appendCalc('0')">0</button>
            <button class="calc-btn" onclick="appendCalc('.')">.</button>
            <button class="calc-btn equals" onclick="calculateResult()">=</button>
        </div>
    </div>

    <!-- CSVÂá∫Âäõ„É¢„Éº„ÉÄ„É´ -->
    <div class="csv-modal" id="csvModal">
        <div class="modal-header">
            <h2>üì• CSVÂá∫Âäõ</h2>
            <button class="modal-close" onclick="closeCSVModal()">‚úï</button>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.08); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; color: #e0e0e0; font-weight: 700;">Âá∫ÂäõÁØÑÂõ≤</label>
                <select id="csvRangeType" onchange="toggleDateRange()" style="width: 100%;">
                    <option value="current">‰ªäÊúà„ÅÆ„Åø</option>
                    <option value="range">ÊúüÈñì„ÇíÊåáÂÆö</option>
                    <option value="all">ÂÖ®ÊúüÈñì</option>
                </select>
            </div>

            <div id="dateRangeInputs" style="display: none;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-direction: column;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #e0e0e0; font-weight: 700;">ÈñãÂßãÂπ¥Êúà</label>
                        <input type="month" id="csvStartDate" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #e0e0e0; font-weight: 700;">ÁµÇ‰∫ÜÂπ¥Êúà</label>
                        <input type="month" id="csvEndDate" style="width: 100%;">
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; color: #e0e0e0; font-weight: 700;">
                    <input type="checkbox" id="csvIncludeNotes" checked style="margin-right: 8px;">
                    ÂÇôËÄÉ„ÇíÂê´„ÇÅ„Çã
                </label>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; color: #e0e0e0; font-weight: 700;">
                    <input type="checkbox" id="csvIncludeHalf" checked style="margin-right: 8px;">
                    ÊäòÂçäÈáëÈ°ç„ÇíÂê´„ÇÅ„Çã
                </label>
            </div>
        </div>

        <button onclick="exportCSV()" style="width: 100%; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);">
            üì• CSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        </button>
    </div>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <div class="container">
        <div class="content-section">
            <div class="sync-status" id="syncStatus">Êé•Á∂ö‰∏≠...</div>

            <div class="month-selector">
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">‚óÄ</button>
                    <div class="month-display" id="currentMonth"></div>
                    <button onclick="changeMonth(1)">‚ñ∂</button>
                </div>
                <button onclick="copyFromPreviousMonth()" style="width: 100%; background: #ffc107; color: #333;">üìã ÂÖàÊúàÂàÜ„Çí„Ç≥„Éî„Éº</button>
            </div>

            <div class="add-category">
                <div class="input-group">
                    <input type="text" id="newCategoryName" placeholder="Â§ß„Ç´„ÉÜ„Ç¥„É™„ÉºÂêçÔºà‰æãÔºöÂÖâÁÜ±Ë≤ªÔºâ">
                    <input type="number" id="newCategoryAmount" placeholder="ÈáëÈ°ç">
                    <input type="text" id="newCategoryNote" placeholder="ÂÇôËÄÉÔºà‰ªªÊÑèÔºâ">
                    <button onclick="addCategory()">ËøΩÂä†</button>
                </div>
            </div>

            <div class="category-list simple-mode" id="categoryList"></div>

            <div class="total-section">
                <h2>ÂêàË®àÈáëÈ°ç</h2>
                <div class="total-amount" id="totalAmount">¬•0</div>
                <div class="half-amount" id="halfAmount">ÊäòÂçä: ¬•0</div>
            </div>

            <div class="output-section">
                <h2 style="margin-bottom: 15px;">„ÉÜ„Ç≠„Çπ„ÉàÂá∫Âäõ</h2>
                <div class="output-text" id="outputText"></div>
                <button class="copy-btn" onclick="copyOutput()">üìã „Ç≥„Éî„Éº</button>
                <div class="copy-success" id="copySuccess" style="display: none;">„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ</div>
                <button class="discord-btn" onclick="window.open('https://discord.com/channels/1360206899278118972/1366013675051159564', '_blank')">
                    <svg class="discord-icon" viewBox="0 0 71 55" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z" fill="white"/>
                    </svg>
                    Discord„Å´ÁßªÂãï
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBhFzS8r2T4zvaEwC6EbH4wbt2sEuf9sEE",
            authDomain: "kakeibo-cc964.firebaseapp.com",
            projectId: "kakeibo-cc964",
            storageBucket: "kakeibo-cc964.firebasestorage.app",
            messagingSenderId: "120845540864",
            appId: "1:120845540864:web:a7a3d776ba900f2e0202e5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let budgetData = {};
        let isInitialLoad = true;
        let calcExpression = '';

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        window.showSection = function(section) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (section === 'budget') {
                const today = new Date();
                const jstOffset = 9 * 60;
                const jstTime = new Date(today.getTime() + (today.getTimezoneOffset() + jstOffset) * 60000);
                
                currentYear = jstTime.getFullYear();
                currentMonth = jstTime.getMonth() + 1;
                
                updateDisplay();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.showCalculator = function() {
            document.getElementById('calculatorModal').classList.add('show');
            clearCalc();
        };

        window.closeCalculator = function() {
            document.getElementById('calculatorModal').classList.remove('show');
        };

        window.clearCalc = function() {
            calcExpression = '';
            document.getElementById('calcDisplay').textContent = '0';
        };

        window.appendCalc = function(value) {
            if (calcExpression === '0' || calcExpression === '„Ç®„É©„Éº') {
                calcExpression = value;
            } else {
                calcExpression += value;
            }
            document.getElementById('calcDisplay').textContent = calcExpression;
        };

        window.calculateResult = function() {
            try {
                let expression = calcExpression.replace(/√ó/g, '*').replace(/√∑/g, '/');
                let result = eval(expression);
                result = Math.round(result * 100) / 100;
                calcExpression = result.toString();
                document.getElementById('calcDisplay').textContent = result;
            } catch (error) {
                document.getElementById('calcDisplay').textContent = '„Ç®„É©„Éº';
                calcExpression = '„Ç®„É©„Éº';
            }
        };

        window.copyCalcResult = function() {
            const result = document.getElementById('calcDisplay').textContent;
            if (result && result !== '0' && result !== '„Ç®„É©„Éº') {
                const textarea = document.createElement('textarea');
                textarea.value = result;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    if (successful) {
                        showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
                    } else {
                        showToast('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                } catch (err) {
                    document.body.removeChild(textarea);
                    console.error('„Ç≥„Éî„ÉºÂ§±Êïó:', err);
                    showToast('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }
        };

        window.showCSVModal = function() {
            document.getElementById('csvModal').classList.add('show');
        };

        window.closeCSVModal = function() {
            document.getElementById('csvModal').classList.remove('show');
        };

        function showSyncStatus(status, message) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.className = 'sync-status ' + status;
            statusEl.textContent = message;
        }

        function getCurrentMonthKey() {
            return currentYear + '-' + String(currentMonth).padStart(2, '0');
        }

        function getCurrentMonthData() {
            const key = getCurrentMonthKey();
            if (!budgetData[key]) {
                budgetData[key] = { categories: [] };
            }
            return budgetData[key];
        }

        async function saveToFirestore() {
            try {
                const docRef = doc(db, 'budgetData', 'data');
                await setDoc(docRef, { data: budgetData });
                showSyncStatus('synced', '‚úì ÂêåÊúüÂÆå‰∫Ü');
                setTimeout(() => {
                    const statusEl = document.getElementById('syncStatus');
                    if (statusEl.textContent === '‚úì ÂêåÊúüÂÆå‰∫Ü') {
                        statusEl.style.display = 'none';
                    }
                }, 2000);
            } catch (error) {
                console.error('Firestore‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showSyncStatus('error', '‚úó ÂêåÊúü„Ç®„É©„Éº: ' + error.message);
            }
        }

        function loadFromFirestore() {
            const docRef = doc(db, 'budgetData', 'data');
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.data) {
                        budgetData = data.data;
                        updateDisplay();
                        
                        if (isInitialLoad) {
                            showSyncStatus('synced', '‚úì „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
                            isInitialLoad = false;
                            setTimeout(() => {
                                document.getElementById('syncStatus').style.display = 'none';
                            }, 2000);
                        }
                    }
                } else {
                    showSyncStatus('synced', '‚úì Êé•Á∂öÂÆå‰∫ÜÔºà„Éá„Éº„Çø„Å™„ÅóÔºâ');
                    setTimeout(() => {
                        document.getElementById('syncStatus').style.display = 'none';
                    }, 2000);
                }
            }, (error) => {
                console.error('FirestoreË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                showSyncStatus('error', '‚úó Êé•Á∂ö„Ç®„É©„Éº: ' + error.message);
            });
        }

        window.changeMonth = function(delta) {
            currentMonth += delta;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            } else if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            
            const monthDisplay = document.getElementById('currentMonth');
            monthDisplay.style.opacity = '0';
            monthDisplay.style.transform = 'scale(0.9)';
            
            setTimeout(() => {
                updateDisplay();
                monthDisplay.style.transition = 'all 0.3s ease';
                monthDisplay.style.opacity = '1';
                monthDisplay.style.transform = 'scale(1)';
            }, 150);
        };

        window.addCategory = function() {
            const name = document.getElementById('newCategoryName').value.trim();
            const amount = document.getElementById('newCategoryAmount').value;
            const note = document.getElementById('newCategoryNote').value.trim();

            if (!name) {
                alert('„Ç´„ÉÜ„Ç¥„É™„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const monthData = getCurrentMonthData();
            monthData.categories.push({
                id: Date.now(),
                name: name,
                amount: amount ? parseFloat(amount) : 0,
                note: note,
                subcategories: []
            });

            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryAmount').value = '';
            document.getElementById('newCategoryNote').value = '';
            
            showSyncStatus('syncing', 'ÂêåÊúü‰∏≠...');
            saveToFirestore();
        };

        window.addSubcategory = function(categoryId) {
            const name = document.getElementById('subname-' + categoryId).value.trim();
            const amount = document.getElementById('subamount-' + categoryId).value;
            const note = document.getElementById('subnote-' + categoryId).value.trim();

            if (!name) {
                alert('È†ÖÁõÆÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const monthData = getCurrentMonthData();
            const category = monthData.categories.find(c => c.id === categoryId);
            
            if (category) {
                category.subcategories.push({
                    id: Date.now(),
                    name: name,
                    amount: amount ? parseFloat(amount) : 0,
                    note: note
                });

                document.getElementById('subname-' + categoryId).value = '';
                document.getElementById('subamount-' + categoryId).value = '';
                document.getElementById('subnote-' + categoryId).value = '';
                
                showSyncStatus('syncing', 'ÂêåÊúü‰∏≠...');
                saveToFirestore();
            }
        };

        window.deleteCategory = function(categoryId) {
            if (!confirm('„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Éº„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

            const monthData = getCurrentMonthData();
            monthData.categories = monthData.categories.filter(c => c.id !== categoryId);
            
            showSyncStatus('syncing', 'ÂêåÊúü‰∏≠...');
            saveToFirestore();
        };

        window.deleteSubcategory = function(categoryId, subcategoryId) {
            if (!confirm('„Åì„ÅÆÈ†ÖÁõÆ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

            const monthData = getCurrentMonthData();
            const category = monthData.categories.find(c => c.id === categoryId);
            
            if (category) {
                category.subcategories = category.subcategories.filter(s => s.id !== subcategoryId);
                showSyncStatus('syncing', 'ÂêåÊúü‰∏≠...');
                saveToFirestore();
            }
        };

        window.editCategory = function(categoryId) {
            const monthData = getCurrentMonthData();
            const category = monthData.categories.find(c => c.id === categoryId);
            
            if (category) {
                const newName = prompt('„Ç´„ÉÜ„Ç¥„É™„ÉºÂêç„ÇíÂÖ•Âäõ:', category.name);
                if (newName !== null && newName.trim()) {
                    category.name = newName.trim();
                    showSyncStatus('syncing', 'ÂêåÊúü‰∏≠...');
                    saveToFirestore();
                }
            }
        };

        window.editSubcategory = function(categoryId, subcategoryId) {
            const monthData = getCurrentMonthData();
            const category = monthData.categories.find(c => c.id === categoryId);
            
            if (category) {
                const subcategory = category.subcategories.find(s => s.id === subcategoryId);
                if (subcategory) {
                    const newName = prompt('È†ÖÁõÆÂêç„ÇíÂÖ•Âäõ:', subcategory.name);
                    if (newName !== null && newName.trim()) {
                        subcategory.name = newName.trim();
                        showSyncStatus('syncing', 'ÂêåÊúü‰∏≠...');
                        saveToFirestore();
                    }
                }
            }
        };

        window.updateAmount = function(categoryId, subcategoryId) {
            const monthData = getCurrentMonthData();
            const category = monthData.categories.find(c => c.id === categoryId);
            
            if (category) {
                if (subcategoryId === null) {
                    const input = document.getElementById('amount-' + categoryId);
                    category.amount = parseFloat(input.value) || 0;
                } else {
                    const subcategory = category.subcategories.find(s => s.id === subcategoryId);
                    if (subcategory) {
                        const input = document.getElementById('subamount-' + categoryId + '-' + subcategoryId);
                        subcategory.amount = parseFloat(input.value) || 0;
                    }
                }
                showSyncStatus('syncing', 'ÂêåÊúü‰∏≠...');
                saveToFirestore();
            }
        };

        window.updateNote = function(categoryId, subcategoryId) {
            const monthData = getCurrentMonthData();
            const category = monthData.categories.find(c => c.id === categoryId);
            
            if (category) {
                if (subcategoryId === null) {
                    const input = document.getElementById('note-' + categoryId);
                    category.note = input.value.trim();
                } else {
                    const subcategory = category.subcategories.find(s => s.id === subcategoryId);
                    if (subcategory) {
                        const input = document.getElementById('subnote-edit-' + categoryId + '-' + subcategoryId);
                        subcategory.note = input.value.trim();
                    }
                }
                showSyncStatus('syncing', 'ÂêåÊúü‰∏≠...');
                saveToFirestore();
            }
        };

        window.toggleAccordion = function(categoryId) {
            const details = document.getElementById('details-' + categoryId);
            const icon = document.getElementById('icon-' + categoryId);
            
            if (details.classList.contains('open')) {
                details.classList.remove('open');
                icon.classList.remove('open');
            } else {
                details.classList.add('open');
                icon.classList.add('open');
            }
        };

        window.copyFromPreviousMonth = function() {
            let prevMonth = currentMonth - 1;
            let prevYear = currentYear;
            
            if (prevMonth < 1) {
                prevMonth = 12;
                prevYear--;
            }
            
            const prevKey = prevYear + '-' + String(prevMonth).padStart(2, '0');
            
            if (!budgetData[prevKey] || !budgetData[prevKey].categories || budgetData[prevKey].categories.length === 0) {
                alert('ÂÖàÊúà„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            const currentData = getCurrentMonthData();
            if (currentData.categories.length > 0) {
                if (!confirm('‰ªäÊúà„ÅÆ„Éá„Éº„Çø„Åå‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„Åå„ÄÅ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                    return;
                }
            }
            
            const prevData = budgetData[prevKey];
            const copiedCategories = JSON.parse(JSON.stringify(prevData.categories));
            
            copiedCategories.forEach(category => {
                category.id = Date.now() + Math.random();
                category.subcategories.forEach(sub => {
                    sub.id = Date.now() + Math.random();
                });
            });
            
            currentData.categories = copiedCategories;
            
            showSyncStatus('syncing', 'ÂêåÊúü‰∏≠...');
            saveToFirestore();
            alert('ÂÖàÊúàÂàÜ„ÅÆ„Éá„Éº„Çø„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
        };

        function calculateTotal() {
            const monthData = getCurrentMonthData();
            let total = 0;

            monthData.categories.forEach(category => {
                if (category.subcategories.length === 0) {
                    total += category.amount || 0;
                } else {
                    category.subcategories.forEach(sub => {
                        total += sub.amount || 0;
                    });
                }
            });

            return total;
        }

        function generateOutput() {
            const monthData = getCurrentMonthData();
            const monthKey = getCurrentMonthKey();
            const parts = monthKey.split('-');
            const year = parts[0];
            const month = parts[1];
            
            let output = '„Äê' + year + '/' + month + '„Äë\n';
            
            monthData.categories.forEach(category => {
                if (category.subcategories.length === 0) {
                    const half = Math.round(category.amount / 2);
                    output += category.name + ' ' + category.amount.toLocaleString() + 'ÂÜÜÔºàÊäòÂçä: ' + half.toLocaleString() + 'ÂÜÜÔºâ\n';
                } else {
                    const subTotal = category.subcategories.reduce((sum, sub) => sum + (sub.amount || 0), 0);
                    const subHalf = Math.round(subTotal / 2);
                    const subDetails = category.subcategories
                        .map(sub => {
                            const half = Math.round(sub.amount / 2);
                            return sub.name + ' ' + sub.amount.toLocaleString() + 'ÂÜÜÔºàÊäòÂçä: ' + half.toLocaleString() + 'ÂÜÜÔºâ';
                        })
                        .join(' / ');
                    output += category.name + ' ' + subTotal.toLocaleString() + 'ÂÜÜÔºàÊäòÂçä: ' + subHalf.toLocaleString() + 'ÂÜÜÔºâ\n';
                    output += '  (' + subDetails + ')\n';
                }
            });
            
            const total = calculateTotal();
            const halfTotal = Math.round(total / 2);
            output += '\nTotal: ' + total.toLocaleString() + 'ÂÜÜ\n';
            output += 'ÊäòÂçäTotal: ' + halfTotal.toLocaleString() + 'ÂÜÜ';
            
            return output;
        }

        function updateDisplay() {
            document.getElementById('currentMonth').textContent = currentYear + 'Âπ¥ ' + currentMonth + 'Êúà';

            const monthData = getCurrentMonthData();
            let listHtml = '';
            
            monthData.categories.forEach(category => {
                let subcategoriesHtml = '';
                
                category.subcategories.forEach(sub => {
                    subcategoriesHtml += '<div class="subcategory-item">';
                    subcategoriesHtml += '<div class="sub-row">';
                    subcategoriesHtml += '<div>';
                    subcategoriesHtml += '<span class="subcategory-name">' + sub.name + '</span>';
                    if (sub.note) {
                        subcategoriesHtml += '<div class="note-text">ÂÇôËÄÉ: ' + sub.note + '</div>';
                    }
                    subcategoriesHtml += '</div>';
                    subcategoriesHtml += '<div class="category-amount">';
                    subcategoriesHtml += '<input type="number" id="subamount-' + category.id + '-' + sub.id + '" value="' + sub.amount + '" onchange="updateAmount(' + category.id + ', ' + sub.id + ')">';
                    subcategoriesHtml += '<span>ÂÜÜ</span>';
                    subcategoriesHtml += '<div class="category-actions">';
                    subcategoriesHtml += '<button class="edit-btn" onclick="editSubcategory(' + category.id + ', ' + sub.id + ')">Á∑®ÈõÜ</button>';
                    subcategoriesHtml += '<button class="delete-btn" onclick="deleteSubcategory(' + category.id + ', ' + sub.id + ')">ÂâäÈô§</button>';
                    subcategoriesHtml += '</div></div></div>';
                    subcategoriesHtml += '<input type="text" class="note-input" id="subnote-edit-' + category.id + '-' + sub.id + '" value="' + (sub.note || '') + '" placeholder="ÂÇôËÄÉ„ÇíÂÖ•Âäõ..." onchange="updateNote(' + category.id + ', ' + sub.id + ')">';
                    subcategoriesHtml += '</div>';
                });

                const subTotal = category.subcategories.reduce((sum, sub) => sum + (sub.amount || 0), 0);
                const displayAmount = category.subcategories.length > 0 ? subTotal : category.amount;

                listHtml += '<div class="category-item">';
                
                listHtml += '<div class="category-summary" onclick="toggleAccordion(' + category.id + ')">';
                listHtml += '<div class="category-summary-left">';
                listHtml += '<span class="accordion-icon" id="icon-' + category.id + '">‚ñ∂</span>';
                listHtml += '<span class="category-summary-name">' + category.name + '</span>';
                listHtml += '</div>';
                listHtml += '<span class="category-summary-amount">' + displayAmount.toLocaleString() + 'ÂÜÜ</span>';
                listHtml += '</div>';
                
                listHtml += '<div class="category-details" id="details-' + category.id + '">';
                listHtml += '<div class="category-header">';
                listHtml += '<div>';
                listHtml += '<span class="category-name">' + category.name + '</span>';
                if (category.note) {
                    listHtml += '<div class="note-text">ÂÇôËÄÉ: ' + category.note + '</div>';
                }
                listHtml += '</div>';
                listHtml += '<div class="category-amount">';
                
                if (category.subcategories.length === 0) {
                    listHtml += '<input type="number" id="amount-' + category.id + '" value="' + category.amount + '" onchange="updateAmount(' + category.id + ', null)">';
                    listHtml += '<span>ÂÜÜ</span>';
                } else {
                    listHtml += '<span style="font-size: 18px; font-weight: bold;">ÂêàË®à: ' + displayAmount.toLocaleString() + 'ÂÜÜ</span>';
                }
                
                listHtml += '<div class="category-actions">';
                listHtml += '<button class="edit-btn" onclick="editCategory(' + category.id + ')">Á∑®ÈõÜ</button>';
                listHtml += '<button class="delete-btn" onclick="deleteCategory(' + category.id + ')">ÂâäÈô§</button>';
                listHtml += '</div></div></div>';
                
                if (category.subcategories.length === 0) {
                    listHtml += '<div style="margin-top: 10px;">';
                    listHtml += '<input type="text" class="note-input" id="note-' + category.id + '" value="' + (category.note || '') + '" placeholder="ÂÇôËÄÉ„ÇíÂÖ•Âäõ..." onchange="updateNote(' + category.id + ', null)">';
                    listHtml += '</div>';
                }
                
                if (category.subcategories.length > 0) {
                    listHtml += '<div class="subcategory-list">' + subcategoriesHtml + '</div>';
                }
                
                listHtml += '<div class="add-subcategory">';
                listHtml += '<div class="input-group">';
                listHtml += '<input type="text" id="subname-' + category.id + '" placeholder="Â∞è„Ç´„ÉÜ„Ç¥„É™„ÉºÔºà‰æãÔºöÈõªÊ∞óÔºâ">';
                listHtml += '<input type="number" id="subamount-' + category.id + '" placeholder="ÈáëÈ°ç">';
                listHtml += '<input type="text" id="subnote-' + category.id + '" placeholder="ÂÇôËÄÉÔºà‰ªªÊÑèÔºâ">';
                listHtml += '<button onclick="addSubcategory(' + category.id + ')">ËøΩÂä†</button>';
                listHtml += '</div></div>';
                
                listHtml += '</div>';
                listHtml += '</div>';
            });

            document.getElementById('categoryList').innerHTML = listHtml;

            const total = calculateTotal();
            const half = Math.round(total / 2);
            document.getElementById('totalAmount').textContent = '¬•' + total.toLocaleString();
            document.getElementById('halfAmount').textContent = 'ÊäòÂçä: ¬•' + half.toLocaleString();
            document.getElementById('outputText').textContent = generateOutput();
        }

        window.copyOutput = function() {
            const text = document.getElementById('outputText').textContent;
            navigator.clipboard.writeText(text).then(() => {
                const successMsg = document.getElementById('copySuccess');
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 2000);
            });
        };

        window.toggleDateRange = function() {
            const rangeType = document.getElementById('csvRangeType').value;
            const dateRangeInputs = document.getElementById('dateRangeInputs');
            
            if (rangeType === 'range') {
                dateRangeInputs.style.display = 'block';
                const today = new Date();
                const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
                document.getElementById('csvStartDate').value = currentMonth;
                document.getElementById('csvEndDate').value = currentMonth;
            } else {
                dateRangeInputs.style.display = 'none';
            }
        };

        window.exportCSV = function() {
            const rangeType = document.getElementById('csvRangeType').value;
            const includeNotes = document.getElementById('csvIncludeNotes').checked;
            const includeHalf = document.getElementById('csvIncludeHalf').checked;
            
            let monthsToExport = [];
            
            if (rangeType === 'current') {
                monthsToExport.push(getCurrentMonthKey());
            } else if (rangeType === 'all') {
                monthsToExport = Object.keys(budgetData).sort();
            } else if (rangeType === 'range') {
                const startDate = document.getElementById('csvStartDate').value;
                const endDate = document.getElementById('csvEndDate').value;
                
                if (!startDate || !endDate) {
                    alert('ÈñãÂßãÂπ¥Êúà„Å®ÁµÇ‰∫ÜÂπ¥Êúà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                const start = new Date(startDate + '-01');
                const end = new Date(endDate + '-01');
                
                if (start > end) {
                    alert('ÈñãÂßãÂπ¥Êúà„ÅØÁµÇ‰∫ÜÂπ¥Êúà„Çà„ÇäÂâç„Å´Ë®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                Object.keys(budgetData).forEach(key => {
                    const date = new Date(key + '-01');
                    if (date >= start && date <= end) {
                        monthsToExport.push(key);
                    }
                });
                
                monthsToExport.sort();
            }
            
            if (monthsToExport.length === 0) {
                alert('Âá∫Âäõ„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            let csvContent = '\uFEFF';
            
            let headers = ['Âπ¥Êúà', 'Â§ß„Ç´„ÉÜ„Ç¥„É™„Éº', 'Â∞è„Ç´„ÉÜ„Ç¥„É™„Éº', 'ÈáëÈ°ç'];
            if (includeHalf) {
                headers.push('ÊäòÂçäÈáëÈ°ç');
            }
            if (includeNotes) {
                headers.push('ÂÇôËÄÉ');
            }
            csvContent += headers.join(',') + '\n';
            
            monthsToExport.forEach(monthKey => {
                const monthData = budgetData[monthKey];
                if (!monthData || !monthData.categories) return;
                
                monthData.categories.forEach(category => {
                    if (category.subcategories && category.subcategories.length > 0) {
                        category.subcategories.forEach(sub => {
                            let row = [
                                monthKey,
                                '"' + category.name + '"',
                                '"' + sub.name + '"',
                                sub.amount || 0
                            ];
                            
                            if (includeHalf) {
                                row.push(Math.round((sub.amount || 0) / 2));
                            }
                            
                            if (includeNotes) {
                                row.push('"' + (sub.note || '') + '"');
                            }
                            
                            csvContent += row.join(',') + '\n';
                        });
                    } else {
                        let row = [
                            monthKey,
                            '"' + category.name + '"',
                            '',
                            category.amount || 0
                        ];
                        
                        if (includeHalf) {
                            row.push(Math.round((category.amount || 0) / 2));
                        }
                        
                        if (includeNotes) {
                            row.push('"' + (category.note || '') + '"');
                        }
                        
                        csvContent += row.join(',') + '\n';
                    }
                });
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const filename = rangeType === 'current' 
                ? 'ÂÆ∂Ë®àÁ∞ø_' + getCurrentMonthKey() + '.csv'
                : rangeType === 'all'
                ? 'ÂÆ∂Ë®àÁ∞ø_ÂÖ®ÊúüÈñì.csv'
                : 'ÂÆ∂Ë®àÁ∞ø_' + document.getElementById('csvStartDate').value + '_' + document.getElementById('csvEndDate').value + '.csv';
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('CSV„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü');
            closeCSVModal();
        };

        showSyncStatus('syncing', 'Êé•Á∂ö‰∏≠...');
        loadFromFirestore();
        updateDisplay();
    </script>
</body>
</html>
